<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Finance-crowler</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  </head>
  <body>
    <div id="react_container"></div>
    <script type="text/babel">
const currency = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB'})
class App extends React.Component {
  state = { graph: [], products: [] };
  elements = {
    graph: React.createRef()
  }

  componentDidMount() {
    fetch('/alfa-capital/products-info?only_actual_pifs=true')
      .then(response => response.json())
      .then(response => {
        this.setState({ products: response.data });
        this.changePif(response.data[0].id);
      })
  }

  render() {
    const {
      products,
      graph,
    } = this.state;

    return <>
      <select onChange={(e) => this.changePif(e.target.value)}>
        {products.map(({ id, title}) => (
          <option key={id} value={id}>{title}</option>
        ))}
      </select>
      <br/>
      <br/>
      <div ref={this.elements.graph}></div>
      <table table="1" rules="rows" width="400px" frame="hsides">
        <thead>
          <tr>
            <th align="left">Дата</th>
            <th align="right">Цена</th>
            <th align="right">СЧА</th>
          </tr>
        </thead>
        <tbody>
          {graph.map(({date, price, scha}) => (
            <tr key={date}>
              <td align="left" width="75">{date.toLocaleDateString('ru-RU',{ year: 'numeric', month: 'numeric', day: 'numeric'})}</td>
              <td align="right">{currency.format(price)}</td>
              <td align="right">{currency.format(scha)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </>
  }

  changePif = (value) => {
    fetch(`/alfa-capital/graph?id=${value}`)
      .then(response => response.json())
      .then(response => {
        this.setState({
          graph: response.data.map(({date, price, scha}) => ({
            date: new Date(date),
            price: price / 100,
            scha: scha / 100,
          })),
        });
        this.drawChart();
      })
  }

  drawChart = () => {
    google.charts.load('current', {packages:['corechart']});
    google.charts.setOnLoadCallback(() => {
      const data = google.visualization.arrayToDataTable([
        ['Дата', 'Цена'],
        ...this.state.graph.map(({ date, price, scha }) => [date, price]),
      ]);
  
      const options = {
        title: 'Company Performance',
        curveType: 'function',
        legend: { position: 'bottom' }
      };
      
      const chart = new google.visualization.LineChart(this.elements.graph.current);
      chart.draw(data, options);
    });
  }
}

const domContainer = document.querySelector('#react_container');

ReactDOM.render(<App />, domContainer);
    </script>
  </body>
</html>
