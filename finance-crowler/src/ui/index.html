<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Finance-crowler</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  </head>
  <body>
    <div id="react_container"></div>
    <script type="text/babel">
function getISODate(date) {
  return date.toISOString().split('T')[0]
}

class Graph extends React.PureComponent {
  root = React.createRef();
  componentDidMount() {
    this.draw();
  }
  componentDidUpdate() {
    this.draw();
  }
  render() {
    return (
      <div ref={this.root} style={{height: '800px'}}></div>
    )
  }

  draw = () => {
    google.charts.load('current', {packages:['corechart']});
    google.charts.setOnLoadCallback(() => {
      const data = google.visualization.arrayToDataTable([
        ['Дата', 'Цена'],
        ...this.props.value.map(({ date, price, scha }) => [date, price]),
      ]);
  
      const options = {
        title: 'Company Performance',
        curveType: 'none',
        legend: { position: 'bottom' },
        chartArea: {
          height: 700,
          width: '90%',
        }
      };
      
      const chart = new google.visualization.LineChart(this.root.current);
      chart.draw(data, options);
    });
  }
}

class Table extends React.PureComponent {
  render() {
    const {
      value,
    } = this.props;

    return (
      <table table="1" rules="rows" width="400px" frame="hsides">
        <thead>
          <tr>
            <th align="left">Дата</th>
            <th align="right">Цена</th>
            <th align="right">СЧА</th>
          </tr>
        </thead>
        <tbody>
          {value.map(({date, price, scha}) => (
            <tr key={date}>
              <td align="left" width="75">{date.toLocaleDateString('ru-RU',{ year: 'numeric', month: 'numeric', day: 'numeric'})}</td>
              <td align="right">{currency.format(price)}</td>
              <td align="right">{currency.format(scha)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    )
  }
}

const currency = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB'})
class App extends React.Component {
  state = {
    graph: [],
    products: [],
    viewType: 'graph',
    minDate: (() => {
      const minDate = new Date();
      minDate.setMonth(minDate.getMonth() - 3);
      return minDate;
    })(),
    maxDate: new Date(),
    productId: null,
  };

  componentDidMount() {
    fetch('/alfa-capital/products-info?only_actual_pifs=true')
      .then(response => response.json())
      .then(response => {
        this.setState({ products: response.data, productId: response.data[0].id });
      })
  }

  componentDidUpdate(prevProps, prevState) {
    const {
      maxDate,
      minDate,
      productId,
    } = this.state;
    if (productId === null) {
      return
    }
    if (
      prevState.productId !== productId
      || prevState.maxDate !== maxDate
      || prevState.minDate !== minDate
    ) {
      this.changePif();
    }
  }

  render() {
    const {
      products,
      graph,
      viewType,
      maxDate,
      minDate,
    } = this.state;

    return <>
      <select onChange={(e) => this.setState({ productId: e.target.value })}>
        {products.map(({ id, title}) => (
          <option key={id} value={id}>{title}</option>
        ))}
      </select>
      <br/>
      <br/>
      <input type="radio" name="viewType" value="table" onChange={() => this.setState({ viewType: 'table' })} /> Таблица
      <input type="radio" name="viewType" value="graph" defaultChecked onChange={() => this.setState({ viewType: 'graph' })}/> График
      <input
        type="date"
        name="minDate"
        value={getISODate(minDate)}
        max={getISODate(maxDate)}
        onChange={(e) => this.setState({ minDate: new Date(e.target.value) })}
      />
      <input
        type="date"
        name="maxDate"
        value={getISODate(maxDate)}
        min={getISODate(minDate)}
        onChange={(e) => this.setState({ maxDate: new Date(e.target.value) })}
      /> 
      {viewType == 'graph' &&
        <Graph value={graph}/>
      }
      {viewType == 'table' &&
        <Table value={graph}/>
      }
    </>
  }

  changePif = () => {
    const {
      maxDate,
      minDate,
      productId,
    } = this.state;
    fetch(`/alfa-capital/graph?id=${productId}&minDate=${getISODate(minDate)}&maxDate=${getISODate(maxDate)}`)
      .then(response => response.json())
      .then(response => {
        this.setState({
          graph: response.data.map(({date, price, scha}) => ({
            date: new Date(date),
            price: price / 100,
            scha: scha / 100,
          })),
        });
      })
  }
}

const domContainer = document.querySelector('#react_container');

ReactDOM.render(<App />, domContainer);
    </script>
  </body>
</html>
